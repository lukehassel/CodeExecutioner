name: Run GFlow Experiment

# Trigger the workflow on push to main or manually via the Actions tab
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-experiment:
    runs-on: ubuntu-latest

    steps:
    # 1. Check out the repository code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Set up Python 3.10
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip' # Caches dependencies to speed up future runs

    # 3. Install PyTorch and NumPy
    # We use the CPU-only version of PyTorch to save download time and space on the runner
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy
        pip install torch --index-url https://download.pytorch.org/whl/cpu

    # 4. Run the script and capture output
    # This runs main.py and redirects stdout (print) to 'experiment_results.txt'
    - name: Run GFlow Model
      run: |
        python main.py > experiment_results.txt
        cat experiment_results.txt  # Also show output in the Action logs

    # 5. Commit and Push the results
    - name: Commit and Push Results
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if the file exists and stage it
        git add experiment_results.txt
        
        # Commit changes (if any)
        # The '|| exit 0' prevents the action from failing if there are no changes to commit
        git commit -m "Update GFlow experiment results [skip ci]" || exit 0
        
        git push
